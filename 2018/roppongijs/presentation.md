# Webpagetestから始める継続的なパッケージ改善

---

## なぜ計測するの？

## 改善には指標が必要

---

継続的な変化をするためには進化的ないといけない

それって

- モノリシックじゃない泥団子じゃない
- 小さく変化して、小さくデプロイできる
- 指標や方向を持って変化する
    - その変化は正しい変化であったかを確認するすべを持つ
    - それが今回の計測でもある

> -- [Building Evolutionary Architectures](http://shop.oreilly.com/product/0636920080237.do)([進化的アーキテクチャ](https://www.oreilly.co.jp/books/9784873118567/))

## 指標は目的で異なる

- ページの表示速度を改善したい(ページロード)
    - URLにアクセスしてからできるだけコンテンツを早く表示したい
    - URLにアクセスしてからできるだけ早くコンテンツを操作できるようにしたい
- 動作を高速にしたい(ランタイム)
    - 重たい操作があるのを軽くしたい
    - カクカクする
    - レスポンスのいい検索、メニューがすぐ切り替わる、ページ移動が早い
- 安定した動作をしてほしい
    - ストリーミング再生が安定して行える
    - いきなりクラッシュしないで
- モバイルでも動作が安定してほしい
    - ネットワーク帯域に気を配る

-----

- 今回の例
    - ページの表示速度を改善したい

-----

# 計測する指標

- FFFB
- LoadTim
- First Content Paint

----

## Onload is not 表示速度

----

# 合成モニタリングとリアルユーザーモニタリング

- 合成モニタリング(Synthetic Monitoring)
    - 計測用の仮想環境などから、同じ条件で定期的に繰り返し計測
    - 環境が同じ条件なら計測結果のゆらぎが少ない
- リアルユーザーモニタリング(RUM)
    - ユーザーがページを開いたときにログとして送る
    - ユーザー環境はバラバラなので計測結果のゆらぎは大きい
    - 一方でリアルなデータなので、KPIと値を組み合わせて分析といった用途に使える

----

# 表示速度と指標

- 表示速度を改善したいので、指標は合成モニタリングで集める
- 合成モニタリングなら同じ環境で継続的に計測できる
- => 値同士を比較して差分を見られる
- => 改善は相対で見たほうがわかりやすい

----

# 合成モニタリングを行えるサービス

> Priceは2018年8月時の参考値、プランによってもPriceは異なります。

- [WebPagetest](https://www.webpagetest.org/)(無料 - 制限200チェック/day)
    - OSSなのでPrivateにHoistingもできる
- [SpeedCurve](https://speedcurve.com)(有料 - $20+/month)
- [Calibre](https://calibreapp.com/)(有料 – $29+/month)
- [New Relic Synthetics](https://newrelic.com/products/synthetics)(有料 – $69/month)

----

# 計測してどうする?

## 具体的な例

- JSのmodule対応
- CSSのファイルサイズが極端に大きい
- 不要なものを読み込まない
- Lazy Load
    - Code Splitting
- preloadする

大体の改善はただの正常化である

## 劇的な変換を望む場合はアーキテクチャの変化を

- SSRの対応
- ただしこういう対応をするのも泥団子にしてないこと

# CIで防ごう

- size-limit
- stagingでチェック